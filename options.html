<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>

    <script src="js/core.js"></script>

    <style type="text/css">
        .dialog
        {
            width: 300px;
            height: 150px;
            -webkit-border-radius: 5px;
            -webkit-box-shadow: rgba(0, 0, 0, 0.5) 2px 3px 13px;
            position: absolute;
            display: none;
            background: #fff;
        }
        ul
        {
            list-style: none;
        }
        .nouse
        {
            background: url(images/all_001.png) no-repeat -21px -391px;
        }
        .use
        {
            background: url(images/all_001.png) no-repeat -67px -391px;
        }
        span.state
        {
            display: block;
            float: left;
            width: 14px;
            height: 14px;
            margin-right: 3px;
            margin-top: 1px;
        }
    </style>

    <script type="text/javascript">

        var $ = tx.dom.$, addEvent = tx.event.addEvent, each = tx.util.each, before = tx.dom.before, tag = tx.dom.tag, getParent = tx.dom.getParent;
        function dialog() {
            this.dialogbody = null;
            this.bulid_();
            addEvent(this.dialogbody, "click", function(e) {
                e.stopPropagation();
            });
            var self = this;
            addEvent(document, "click", function(e) {
                self.dialogbody.style.display = "none";
            });
        }

        dialog.prototype = {
            bulid_: function() {
                if ($("dialog")) {
                    this.dialogbody = $("dialog");
                    return;
                }
                var odiv = document.createElement("div");
                odiv.className = "dialog";
                odiv.id = "dialog";
                var oifr = document.createElement("iframe");
                oifr.style.cssText += ";width: 100%; height: 100%; border: 0px;";
                odiv.appendChild(oifr);
                document.body.appendChild(odiv);
                this.dialogbody = odiv;
            },
            close: function() {
                this.dialogbody.style.display = "none";
            },
            open: function(src) {
                tag("iframe", this.dialogbody)[0].src = src;
                this.dialogbody.style.display = "block";
            },
            left: function(num) {
                this.dialogbody.style.left = num + "px";
            },
            top: function(num) {
                this.dialogbody.style.top = num + "px";
            }
        };
        
    </script>

</head>
<body>
    <fieldset>
        <legend>搜索</legend>
        <h5>
            选择引擎</h5>
        <div id="jstemplate" style="display: none;">
            <li><span class="$class state" id="$id" name="engine"></span>
                <label for="$id">
                    $name</label><input type="button" name="enginel" value="编辑" />
            </li>
        </div>
        <span class="state use"></span><span>当前可用</span><br />
        <span class="state nouse"></span><span>当前禁用</span>
        <ul id="engines">
        </ul>
        <input id="add" type="button" value="添加" />
        <h5>
            显示</h5>
        <input id="pop" type="radio" name="show" checked="checked" /><label for="pop">弹出</label>
        <input id="newtab" type="radio" name="show" /><label for="newtab">新标签</label>
        <input id="newwindow" type="radio" name="show" /><label for="newwindow">新窗口</label>
    </fieldset>
    <br />
    <input id="save" type="button" value="保存" /><input id="close" type="button" value="关闭" />

    <script type="text/javascript">
        $("close").onclick = function() {
            window.close();
        };
        var aSaveCallback = [];

        $("save").onclick = function() {
            for (var i = 0; i < aSaveCallback.length; i++) {
                aSaveCallback[i]();
            }
            alert("保存成功！");
        };

        //工具条样式
        function saveShowSearchType() {
            var options = document.getElementsByName("show");
            for (var i = 0; i < options.length; i++) {
                if (options[i].checked) saveData("showsearch", options[i].id);
            }
        }
        aSaveCallback.push(saveShowSearchType);
        resetUI("showsearch", "newwindow");

        function resetUI(key, id) {
            var id = getData(key) || id;
            $(id).checked = true;
        }

        /**
        *预定义的搜索引擎
        */
        var engines_ = [
            {
                id: 0, //搜索引擎id
                orderId: 0,
                name: "用谷歌搜索",
                url: "http://www.google.com/search?q={s}",
                charset: "utf-8",
                pic: "images/google.jpg",
                isused: true //是否使用此搜索引擎
            },
            {
                id: 1,
                orderId: 1,
                name: "用百度搜索",
                url: "http://www.baidu.com/s?ie=utf-8&f=8&wd={s}",
                charset: "utf-8",
                pic: "images/baidu.jpg",
                isused: false
            },
            {
                id: 2,
                orderId: 2,
                name: "必应搜索",
                url: "http://www.bing.com/search?q={s}",
                charset: "utf-8",
                pic: "images/bing.jpg",
                isused: false
            },
            {
                id: 3,
                orderId: 3,
                name: "谷歌购物",
                url: "http://www.google.cn/products?aq=f&q={s}",
                charset: "utf-8",
                pic: "images/shopping.jpg",
                isused: true
            },
            {
                id: 4,
                orderId: 4,
                name: "百度百科",
                url: "http://baike.baidu.com/searchword/?pic=1&sug=1&word={s}",
                charset: "gb2312",
                pic: "images/wiki.jpg",
                isused: true
            }
        ];

        //entity engine
        var engine = {};
        engine.id,
        engine.name = "",
        engine.url = "",
        engine.charset = "utf-8",
        engine.isused = true;

        //初始化数据
        if (localStorage["engines"] == "") localStorage["engines"] = JSON.stringify(engines_);
        var aEngines = localStorage["engines"] ? JSON.parse(localStorage["engines"]) : engines_;

        //对话框
        var dialogupdate, dialogadd; ;

        var engine = {
            addEngine: function(sName, sUrl, isChecked) {
                aEngines.push({
                    id: aEngines.length,
                    orderId: aEngines.length,
                    name: sName,
                    url: sUrl,
                    charset: (isChecked ? "gb2312" : "utf-8"),
                    isused: true
                });
                saveData("engines", JSON.stringify(aEngines));
                console.log(JSON.stringify(aEngines));
                alert("保存成功");
                dialogadd.close();
                this.refreshList();
            },
            cancelAddEngine: function() {
                dialogadd.close();
            },
            deleteEngine: function(id) {
                var index = 0;
                for (index; index < aEngines.length; index++) {
                    if (aEngines[index].id == id) break;
                }
                aEngines.splice(index, 1);
                saveData("engines", JSON.stringify(aEngines));
                console.log(aEngines);
                dialogupdate.close();
                this.refreshList();
            },
            updateEngine: function() {
                var eng = getEngineById(engine.id);
                eng.name = engine.name;
                eng.url = engine.url;
                eng.charset = engine.charset;
                eng.isused = engine.isused;

                console.log("更新搜索引擎:" + JSON.stringify(aEngines));
                //更新显示
                $("engine_" + engine.id).className = engine.isused ? "use" : "nouse";
                saveData("engines", JSON.stringify(aEngines));
                alert("更新成功！");
                this.refreshList();
                dialogupdate.close();
            },
            refreshList: function() {
                var stel = $("jstemplate").innerHTML;
                var alis = [];
                each(aEngines, function() {
                    var str = stel.replace(/\$id/g, "engine_" + this.id).replace(/\$name/, this.name);
                    //添加标注
                    str = this.isused ? str.replace(/\$class/, "use") : str.replace(/\$class/, "nouse");
                    alis.push(str);
                });
                $("engines").innerHTML = alis.join("");


                each(document.getElementsByName("enginel"), function() {
                    addEvent(this, "click", function(e) {
                        var span = tag("span", getParent(this, 1))[0];
                        engine.id = parseInt(span.id.replace(/engine_/, ""));
                        eng = getEngineById(engine.id);
                        engine.name = eng.name;
                        engine.url = eng.url;
                        engine.charset = eng.charset;
                        engine.isused = eng.isused;



                        var ele = e.target;
                        dialogupdate = new dialog();
                        dialogupdate.left(findPos(ele)[0] + ele.offsetWidth);
                        dialogupdate.top(findPos(ele)[1]);
                        dialogupdate.open("update.html");
                        e.stopPropagation();
                    });
                });
            }
        };


        /**
        *初始化列表
        */
        engine.refreshList();

        /**
        *添加搜索引擎
        */

        addEvent($("add"), "click", function(e) {
            var ele = e.target;
            dialogadd = new dialog();
            dialogadd.left(findPos(ele)[0] + ele.offsetWidth / 2);
            dialogadd.top(findPos(ele)[1] + ele.offsetHeight);
            dialogadd.open("add.html");
            e.stopPropagation();
        });


        /**
        *保存数据
        */
        function saveData(key, data) {
            console.log(data.toString());
            (data.toString() == "[]") ? localStorage[key] = "" : localStorage[key] = data;
        }

        function getData(key) {
            return localStorage[key];
        }

        /**计算位置*/
        function findPos(obj) {
            var curleft = curtop = 0;
            if (obj.offsetParent) {
                while (obj.offsetParent) {
                    curleft += obj.offsetLeft;
                    curtop += obj.offsetTop;
                    obj = obj.offsetParent;
                }
            }
            return [curleft, curtop];
        }

        function getEngineById(id) {
            for (var i = 0; i < aEngines.length; i++) {
                if (aEngines[i].id == id) return aEngines[i];
            }
        }
    </script>

</body>
</html>
