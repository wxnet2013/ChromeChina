<script src="js/util.js"></script>
<script type="text/javascript">
    /**
    *预定义的搜索引擎
    */
    var engines_ = JSON.parse(getMessage("engines"));

    var msg = {};

    var xhr = null;
    function HandleStateChange() {
        if (xhr.readyState == 4) {
            var jsontext = xhr.responseText;
            alert(jsontext);
        }
    }

    function sendText(par) {
        var param = [];
        param.push("title=" + par.title);
        param.push("url=" + par.url);
        param.push("text=" + par.text);

        xhr = new XMLHttpRequest();
        xhr.open("POST", "http://text.com/receive.aspx", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=utf-8');
        xhr.onreadystatechange = HandleStateChange;
        xhr.send(param.join("&"));
    }



    //接收content script的消息
    chrome.extension.onConnect.addListener(function(port) {
        var tab = port.sender.tab;
        // This will get called by the content script we execute in
        // the tab as a result of the user pressing the browser action.
        port.onMessage.addListener(function(info) {
            if (info.text) {
                msg.text = info.text;
                sendText(msg);
            } else if (info.title) {
                msg.title = info.title;
                msg.url = info.url;
            } else if (info.newtab) {
                chrome.tabs.create({ url: info.newtab });
            } else if (info.newwindow) {
                chrome.windows.create({
                    top: info.top,
                    left: info.left,
                    width: info.width,
                    height: info.height,
                    url: info.newwindow
                });
            }
        });
    });

    //接收content script 的请求
    chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
        if (request.option == "getinfo")
            sendResponse({
                searchshow: (localStorage["showsearch"] || "newwindow"),
                engines: (localStorage["engines"] || JSON.stringify(engines_)),
                dragengine: (localStorage["dragengine"] || 0),
                dragImageDisplayMode: (localStorage["dragImageDisplayMode"] || "imageview"),
                dragLinkDisplayMode: (localStorage["dragLinkDisplayMode"] || "newwindow")
            });
        else if (request.option == "isfirstrunimageviewer") {
            if (!localStorage['tips']) {
                localStorage['tips'] = true;
                sendResponse({ tip: true });
            } else
                sendResponse({ tip: false });
        } else
            sendResponse({});
    });


    if (!localStorage['firstrun']) {
        chrome.tabs.create({ url: chrome.extension.getURL('options.html'), selected: true });
        localStorage['firstrun'] = true;
    }
</script>

